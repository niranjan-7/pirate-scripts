"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ThePirateBayScraper = void 0;
const node_html_parser_1 = require("node-html-parser");
const fetcher_1 = require("../fetchers/fetcher");
const scraper_helper_1 = require("../helpers/scraper.helper");
const vars_1 = require("../vars");
class ThePirateBayScraper {
    async search(query, provider) {
        const response = await (0, fetcher_1.fetchPage)(query, provider);
        /**
         * Create virtual node for DOM traversing
         * Choose nodejs OR browser version
         */
        // Nodejs version
        const virtualNode = this.nodeDOM(response); // Uncomment when you run in nodejs. Debugging.
        // Browser version
        // const virtualNode = this.browserDOM(response);
        // Get all rows (without header)
        const items = [].slice.call(virtualNode.querySelectorAll('#searchResult tr:not(:first-child)'));
        return this.buildItems(items);
    }
    // private browserDOM(response: string): HTMLHtmlElement {
    //   const html = document.createElement('html');
    //   html.innerHTML = response;
    //   return html;
    // }
    nodeDOM(response) {
        return (0, node_html_parser_1.parse)(response);
    }
    buildItems(items) {
        const torrents = [];
        // Remove last row which is usually pagination
        if (items.length > vars_1.PAGE_SIZE) {
            items.pop();
        }
        for (const item of items) {
            const [seeders, leechers] = (0, scraper_helper_1.getSeedLeech)(item);
            const attrs = (0, scraper_helper_1.getAttrs)(item);
            torrents.push({
                title: (0, scraper_helper_1.getTitle)(item),
                seeders,
                leechers,
                uploaded: (0, scraper_helper_1.getUploaded)(attrs),
                uploader: (0, scraper_helper_1.getUploader)(attrs),
                size: (0, scraper_helper_1.getSize)(attrs),
                link: (0, scraper_helper_1.getLink)(item)
            });
        }
        return torrents;
    }
}
exports.ThePirateBayScraper = ThePirateBayScraper;
